<!DOCTYPE html>
<html>
    <head>
        <title>Emergino</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/foundation.css">
        <link rel="stylesheet" href="css/pohotovost.css">
        <link rel="icon" type="image/png" href="img/favicon.ico">
        <script src="js/vendor/modernizr.js"></script>
        <script src="//code.jquery.com/jquery-1.12.0.min.js"></script>
        <script src="data.js"></script>
        <script>

            // TODO: add choices
            var points = pharmacies;                      
    
            function getLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(showPosition);
                } else {
                    alert("Geolocation is not supported by this browser.");
                }
            }
            var currentLatitude = 12; //null;
            var currentLongitude = 12; //null;
            function showMapWithPosition(lat, long) {
                initMap(lat, long);
            }
            
            function showPosition(position) {
                currentLatitude = position.coords.latitude;
                currentLongitude = position.coords.longitude;
                showMapWithPosition(currentLatitude, currentLongitude);
                showTable();
            }
            function showTable() {
                // Parse JSON string into object
                //var points = JSON.parse(response);

                //console.log(points);

                for(var i = 0; i < points.length; i++) {
                    var point = points[i];
                    point.distance = getDistanceFromLatLonInKm(
                            currentLatitude, currentLongitude,
                            point.lat, point.lon
                            );    
                    //console.log(point.distance);
                }    

                points.sort(function(a, b) {
                    return parseFloat(a.distance) - parseFloat(b.distance);
                });                

                console.log(points);
                
                var tableHtml = 
                  "<table>"
                + "  <tr>.<th></th><th>Name</th><th>Address</th><th>Distance</th><tr>";
        
                for(var i = 0; i < points.length; i++) {
                    var point = points[i];
                    
                    tableHtml += "  <tr><td>"+(1+i)+".<td><td>"+point.name+"</td><td>"+point.address+"</td><td>"+point.distance+" km</td><tr>";
                }    
                
                tableHtml += "</table>";
                
                document.getElementById("table").innerHTML = tableHtml;
            }
            function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
              var R = 6371; // Radius of the earth in km
              var dLat = deg2rad(lat2-lat1);  // deg2rad below
              var dLon = deg2rad(lon2-lon1); 
              var a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2)
                ; 
              var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
              var d = R * c; // Distance in km
              return d;
            }

            function deg2rad(deg) {
              return deg * (Math.PI/180)
            }            
            function run() {
                getLocation();
                showTable();
            };

            /* 
                GOOGLE MAPS FUNCTIONS
            */

            var map;
            var markers = [];

            function initMap(lat, lng) {
              map = new google.maps.Map(document.getElementById('mapholder'), {
                center: {lat: lat, lng: lng},
                zoom: 15
              });
              var marker = new google.maps.Marker({
                position: {lat: lat, lng: lng},
                map: map,
                label: 'Your position'
              });
              markers.push(marker);


              for (var i = 0; i < points.length; i++) {
                addMarker(i, points[i]['lat'], points[i]['lon'], null);
              }
            }

            function addMarker(id, lat, lng, icon) {
              var marker = new google.maps.Marker({
                position: {lat: lat, lng: lng},
                map: map,
                label: ""+id,
                icon: icon
              });

              markers.push(marker);

              marker.addListener('click', function() {
                // TODO: Scroll to correct element
                alert(id);
              });
            }

            function clearMarkers() {
              for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
              }
            }

            function navigateTo(lat, lng) {
                selectedMode = "DRIVING";
                clearMarkers();
                
                var directionsDisplay = new google.maps.DirectionsRenderer;
                var directionsService = new google.maps.DirectionsService;
                directionsDisplay.setMap(map);

                directionsService.route({
                    origin: {lat: currentLatitude, lng: currentLongitude},  // Haight.
                    destination: {lat: lat, lng: lng},  // Ocean Beach.
                    // Note that Javascript allows us to access the constant
                    // using square brackets and a string value as its
                    // "property."
                    travelMode: google.maps.TravelMode[selectedMode]
                  }, function(response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                      directionsDisplay.setDirections(response);
                    } else {
                      window.alert('Directions request failed due to ' + status);
                    }
                });

            }

        </script>
    </head>
    <body onload="run()">
	<nav class="top-bar" data-topbar role="navigation">
	<section class="top-bar-section">
	<ul class="left">
      <li class="has-dropdown">
        <a href="#">
        	<img src="img/menu.png" alt="Emergency">
        </a>
        <ul class="dropdown">
          <li><a href="#">Emergency</a></li>
          <li><a href="#">Dental</a></li>
          <li><a href="#">Pharmacy</a></li>
        </ul>
      </li>
      <li><a href="index.html">
      	<img src="img/emergino-logo_white.png" alt="emergino">
      </a></li>
    </ul>
  </section>
</nav>
		<!-- <nav class="top-bar" data-topbar role="navigation">
		  <div class="row title-area">
		    <div class="name small-12 columns">
		      <a href="pohotovost.html">
		      	<img src="img/emergino-logo_white.png" alt="emergino">
		      </a>
		    </div>
		  </div>
		</nav> -->
		<section class="map">
                <div id="mapholder" ></div>
                <div id="googlemaps"></div>
		<!--<img src="img/maps.png" alt="maps">-->
		</section>
		<section class="table">
			<ul class="accordion" data-accordion>
			  <li class="accordion-navigation">
			    <a href="#panel1a">Accordion 1</a>
			    <div id="panel1a" class="content active">
                                <div id="table"></div>
			   </div>
			  </li>
			  <li class="accordion-navigation">
			    <a href="#panel2a">Accordion 2</a>
			    <div id="panel2a" class="content">
			      Panel 2. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
			    </div>
			  </li>
			  <li class="accordion-navigation">
			    <a href="#panel3a">Accordion 3</a>
			    <div id="panel3a" class="content">
			      Panel 3. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
			    </div>
			  </li>
			</ul>	
		</section>
		<script src="js/vendor/jquery.js"></script>
	    <script src="js/foundation.min.js"></script>
	    <script src="js/vendor/jquery-ui-1.11.4.custom/jquery-ui.min.js"></script>
	    <script src="js/pohotovost.js"></script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBSvG2HflFKGGYvtu1hJzPgLbKxriyIb7s"></script>
	    <script>
	      $(document).foundation();
	    </script>
        <div id="mapholder"></div>
        <div id="table"></div>
    </body>
</html>
